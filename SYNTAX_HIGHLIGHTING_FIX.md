# Syntax Highlighting Fix for Zed Extension

## Problem

The Zed extension was not showing syntax highlighting for Antlers templates. The issue was in the `queries/highlights.scm` file, which contained incorrect node patterns that didn't match the actual tree structure generated by the grammar.

## Root Cause

The main issues were:

1. **Incorrect child node matching**: Several highlight queries tried to match child nodes that don't exist because their parent nodes are terminal tokens.

   Example: `(parameter_name (identifier) @property)`
   
   The grammar defines `parameter_name` as:
   ```javascript
   parameter_name: ($) => token(seq(optional(":"), /[a-zA-Z_][a-zA-Z0-9_]*/))
   ```
   
   When you use `token()`, it creates a single terminal node with no children. The highlight query was trying to match an `identifier` child that doesn't exist.

2. **Missing delimiter highlighting**: The Antlers delimiters (`{{`, `}}`, `{{#`, etc.) weren't being highlighted, making it harder to distinguish template boundaries.

3. **Poor query organization**: The queries weren't organized by specificity, which could cause less specific patterns to match before more specific ones.

## Solution

The `queries/highlights.scm` file has been completely rewritten to:

1. **Match actual node structure**: Changed queries to match the actual tree structure
   - `(parameter_name) @property` instead of `(parameter_name (identifier) @property)`
   - Added proper field selectors where needed (e.g., `method: (identifier)`)

2. **Added delimiter highlighting**: All Antlers delimiters are now highlighted as `@punctuation.special`
   - `{{ }}` - Regular Antlers delimiters
   - `{{# #}}` - Comment delimiters
   - `{{? ?}}` - PHP statement delimiters
   - `{{$ $}}` - PHP echo delimiters

3. **Improved organization**: Queries are now organized by category with clear sections:
   - Delimiters (highest priority)
   - Comments
   - Literals (strings, numbers, booleans, null)
   - Keywords
   - Functions and Methods
   - Properties and Parameters
   - Variables
   - Operators
   - Punctuation
   - Special Content (PHP, noparse, text)

4. **Better specificity**: More specific patterns now appear before general ones to ensure correct matching precedence

## Changes Made

### Before
```scheme
; Parameters
(parameter_name (identifier) @property)

; Variables and identifiers
(identifier) @variable
(variable (identifier) @variable)

; Tags
(tag_name (identifier) @function)
```

### After
```scheme
; Parameter names: {{ tag param="value" }}
; Note: parameter_name is a terminal token, not a parent node
(parameter_name) @property

; Tag names: {{ collection }}
(tag_name
  (identifier) @function)

; Variable with nested access: {{ user:name }} or {{ user.name }}
(variable) @variable

; Simple identifiers (fallback for other identifiers)
(identifier) @variable
```

## Verification

To verify the fix works:

1. The grammar correctly generates terminal nodes for `parameter_name` (confirmed in `src/node-types.json`)
2. Test corpus files show the expected tree structure
3. All standard tree-sitter capture names are used (compatible with Zed themes)

## Capture Names Used

All capture names follow tree-sitter conventions and are supported by Zed:

- `@comment` - Comments
- `@string` - String literals
- `@number` - Numeric literals
- `@constant.builtin` - Booleans and null
- `@variable` - Variables and identifiers
- `@function` - Function/tag names
- `@function.method` - Methods and modifiers
- `@property` - Properties and parameters
- `@operator` - All operators
- `@keyword` - Control flow and array operation keywords
- `@punctuation.bracket` - Brackets: `()`, `[]`
- `@punctuation.delimiter` - Delimiters: `,`, `;`
- `@punctuation.special` - Antlers delimiters: `{{`, `}}`, etc.
- `@embedded` - PHP content for syntax injection
- `@string.special` - Noparse content
- `@none` - Plain text/HTML content

## Next Steps

After this fix:

1. **Rebuild the extension**: If you're using this with a Zed extension, make sure to rebuild the extension so it picks up the updated highlights.scm file.

2. **Test thoroughly**: Open various Antlers templates in Zed to verify that:
   - Tags are highlighted as functions
   - Variables are properly colored
   - Modifiers appear as methods
   - Delimiters are visible
   - Comments are grayed out
   - Strings and numbers have distinct colors

3. **Check injections**: Verify that HTML content outside Antlers tags and PHP content inside `{{? ?}}` blocks are properly highlighted with their respective grammars.

## Technical Notes

- The `token()` function in tree-sitter grammar creates terminal nodes with no children
- Field selectors (e.g., `method: (identifier)`) provide more precise matching
- Query precedence matters: more specific patterns should come first
- External scanner nodes (`antlers_start`, `antlers_end`, etc.) are properly exposed as named nodes for highlighting